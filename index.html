<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Hourly Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .hidden { display: none !important; }
        /* Centered Login Box */
        .login-container { max-width: 400px; margin: 80px auto; padding: 30px; background: white; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        /* Cards */
        .log-card { border-left: 5px solid #0d6efd; margin-bottom: 12px; background: white; }
        .admin-card { border-top: 5px solid #ffc107; background: #fffdf5; }
        .search-card { background: #e9ecef; border: none; }
        /* Role Badge */
        .role-badge { font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; vertical-align: middle; }
    </style>
</head>
<body>

    <div id="loginSection" class="container login-container">
        <h3 class="text-center mb-4 fw-bold">Work Tracker Login</h3>
        <div class="mb-3">
            <label class="form-label">Email ID</label>
            <input type="email" id="loginEmail" class="form-control" placeholder="user@company.com">
        </div>
        <div class="mb-4">
            <label class="form-label">Password</label>
            <input type="password" id="loginPass" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button onclick="loginSystem()" class="btn btn-primary w-100 py-2 fw-bold">Login to Dashboard</button>
    </div>

    <div id="dashboardSection" class="container mt-4 hidden">
        <nav class="navbar navbar-light bg-white p-3 rounded shadow-sm justify-content-between mb-4">
            <div class="d-flex align-items-center">
                <span class="navbar-brand mb-0 h1">Welcome, <span id="userNameDisplay" class="fw-bold">User</span></span>
                <span class="badge bg-dark role-badge ms-2" id="userRoleDisplay">ROLE</span>
            </div>
            <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
        </nav>

        <div class="row">
            <div class="col-md-4">
                
                <div id="logWorkCard" class="card p-3 mb-4 shadow-sm">
                    <h5 class="fw-bold text-primary">üìù Log My Work</h5>
                    <form id="workForm">
                        <div class="row mb-2">
                            <div class="col-6">
                                <label class="small text-muted">From Time</label>
                                <input type="time" id="workStart" class="form-control" required>
                            </div>
                            <div class="col-6">
                                <label class="small text-muted">To Time</label>
                                <input type="time" id="workEnd" class="form-control" required>
                            </div>
                        </div>
                        <div class="mb-2">
                            <label class="small text-muted">Description</label>
                            <textarea id="workDesc" class="form-control" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Submit Log</button>
                    </form>
                </div>

                <div id="adminToolsCard" class="card p-3 mb-4 admin-card hidden shadow-sm">
                    <h5 class="fw-bold text-warning">‚ö° Create New User</h5>
                    <p class="small text-muted mb-2">Add new Employee or HR.</p>
                    
                    <input type="email" id="newEmail" class="form-control mb-2" placeholder="Email Address">
                    <input type="password" id="newPass" class="form-control mb-2" placeholder="Password">
                    <input type="text" id="newName" class="form-control mb-2" placeholder="Full Name">
                    
                    <select id="newRole" class="form-select mb-3">
                        <option value="Employee">Employee</option>
                        </select>
                    
                    <button onclick="createNewUser()" class="btn btn-warning w-100 fw-bold">Create User</button>
                </div>
            </div>

            <div class="col-md-8">
                
                <div id="searchPanel" class="card p-3 mb-4 search-card hidden shadow-sm">
                    <label class="form-label fw-bold">üîç Search Employee Database</label>
                    <div class="input-group">
                        <input type="text" id="searchInput" class="form-control" placeholder="Enter Name or Email...">
                        <button class="btn btn-dark" onclick="searchUserAndLogs()">Search</button>
                        <button class="btn btn-outline-secondary" onclick="resetSearch()">Clear</button>
                    </div>
                </div>

                <div id="manageUserPanel" class="card p-3 mb-3 border-danger hidden" style="background-color: #fff5f5;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="m-0 fw-bold text-danger">User Found: <span id="targetUserName">...</span></h5>
                            <small class="text-muted">Status: <span id="targetUserStatus">Active</span></small>
                        </div>
                        <div>
                            <button id="btnBlockUser" onclick="toggleBlockUser()" class="btn btn-warning btn-sm fw-bold me-2">Block Login</button>
                            <button id="btnDeleteUser" onclick="deleteEntireEmployee()" class="btn btn-danger btn-sm fw-bold hidden">DELETE EMPLOYEE</button>
                        </div>
                    </div>
                </div>

                <div class="card p-3 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="m-0 fw-bold">Work History</h5>
                        <div class="d-flex gap-2">
                            <input type="date" id="filterDate" class="form-control form-control-sm" onchange="loadLogs()">
                            <button class="btn btn-sm btn-light border" onclick="clearDateFilter()">All</button>
                            <button class="btn btn-sm btn-dark" onclick="loadLogs()">Refresh</button>
                        </div>
                    </div>
                    <div id="logsList" style="max-height: 600px; overflow-y: auto;">
                        <p class="text-muted">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, doc, getDoc, setDoc, updateDoc, deleteDoc, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyAgmgOG0I5p2VsedQXorr4xq7fvKOvPRCY",
          authDomain: "work-sheet-4e4b0.firebaseapp.com",
          projectId: "work-sheet-4e4b0",
          storageBucket: "work-sheet-4e4b0.firebasestorage.app",
          messagingSenderId: "370834015544",
          appId: "1:370834015544:web:0dc081da38c9d39dc56dcd",
          measurementId: "G-HH40E4PMM1"
        };

        // Initialize
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global State
        let currentUserRole = null;
        let currentUserId = null;
        let searchedUserUid = null;
        let searchedUserIsBlocked = false;

        // --- 2. LOGIN SYSTEM ---
        window.loginSystem = async () => {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            if(!email || !pass) return alert("Please enter email and password.");
            
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                alert("Login Failed: " + error.message);
            }
        };

        window.logout = () => signOut(auth);

        // --- 3. AUTH LISTENER ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                const docSnap = await getDoc(doc(db, "users", user.uid));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.isBlocked) {
                        alert("Your account is blocked.");
                        await signOut(auth);
                        return;
                    }
                    currentUserRole = data.role;
                    document.getElementById('userNameDisplay').innerText = data.name;
                    document.getElementById('userRoleDisplay').innerText = currentUserRole;
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('dashboardSection').classList.remove('hidden');
                    setupDashboard();
                }
            } else {
                document.getElementById('loginSection').classList.remove('hidden');
                document.getElementById('dashboardSection').classList.add('hidden');
            }
        });

        // --- 4. DASHBOARD SETUP ---
        function setupDashboard() {
            const logCard = document.getElementById('logWorkCard');
            const adminCard = document.getElementById('adminToolsCard');
            const searchPanel = document.getElementById('searchPanel');
            const roleSelect = document.getElementById('newRole');
            const logsList = document.getElementById('logsList');
            
            logCard.classList.add('hidden');
            adminCard.classList.add('hidden');
            searchPanel.classList.add('hidden');
            document.getElementById('manageUserPanel').classList.add('hidden');

            if (currentUserRole === 'MD') {
                adminCard.classList.remove('hidden');
                searchPanel.classList.remove('hidden');
                roleSelect.innerHTML = '<option value="Employee">Employee</option><option value="HR">HR</option>';
                logsList.innerHTML = '<div class="text-center p-5 text-muted"><h4>üëã Dashboard Ready</h4><p>Use the search bar above to view employee data.</p></div>';
            } else if (currentUserRole === 'HR') {
                logCard.classList.remove('hidden');
                adminCard.classList.remove('hidden');
                searchPanel.classList.remove('hidden');
                roleSelect.innerHTML = '<option value="Employee">Employee</option>';
                loadLogs();
            } else {
                logCard.classList.remove('hidden');
                loadLogs();
            }
        }

        // --- 5. LOG WORK (Time Calculation) ---
        document.getElementById('workForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const start = document.getElementById('workStart').value;
            const end = document.getElementById('workEnd').value;
            const desc = document.getElementById('workDesc').value;
            const name = document.getElementById('userNameDisplay').innerText;

            if(!start || !end) return alert("Please select start and end time.");

            // Calculate Duration
            const s = new Date(`1970-01-01T${start}Z`);
            const eTime = new Date(`1970-01-01T${end}Z`);
            let diffMs = eTime - s;
            if(diffMs < 0) diffMs += 24 * 60 * 60 * 1000; // Handle overnight
            const diffHrs = (diffMs / (1000 * 60 * 60)).toFixed(1);
            
            // Get Date String for Filtering (YYYY-MM-DD)
            const today = new Date().toISOString().split('T')[0];

            try {
                await addDoc(collection(db, "work_logs"), {
                    uid: currentUserId,
                    name: name,
                    name_lower: name.toLowerCase(),
                    startTime: start,
                    endTime: end,
                    duration: diffHrs,
                    dateString: today, // Used for date filtering
                    description: desc,
                    timestamp: serverTimestamp()
                });
                document.getElementById('workForm').reset();
                if(currentUserRole !== 'MD' && !searchedUserUid) loadLogs();
                alert(`Logged: ${diffHrs} Hours`);
            } catch (error) { alert("Error: " + error.message); }
        });

        // --- 6. CREATE USER ---
        window.createNewUser = async () => {
            const email = document.getElementById('newEmail').value;
            const pass = document.getElementById('newPass').value;
            const name = document.getElementById('newName').value;
            const role = document.getElementById('newRole').value;

            if(!email || !pass || !name) return alert("Fill all fields");

            if(confirm(`Create ${role}: ${name}?`)) {
                try {
                    const tempApp = initializeApp(firebaseConfig, "TempApp");
                    const tempAuth = getAuth(tempApp);
                    const cred = await createUserWithEmailAndPassword(tempAuth, email, pass);
                    await setDoc(doc(db, "users", cred.user.uid), {
                        name: name,
                        name_lower: name.toLowerCase(),
                        role: role,
                        email: email,
                        isBlocked: false
                    });
                    await signOut(tempAuth);
                    alert("User Created!");
                    document.getElementById('newEmail').value = "";
                    document.getElementById('newPass').value = "";
                    document.getElementById('newName').value = "";
                } catch (e) { alert("Error: " + e.message); }
            }
        };

        // --- 7. SEARCH ---
        window.searchUserAndLogs = async () => {
            const input = document.getElementById('searchInput').value.trim();
            if(!input) return;
            const list = document.getElementById('logsList');
            list.innerHTML = '<p class="text-center mt-4">Searching...</p>';
            
            let targetUid = null;
            let targetName = null;
            let isBlocked = false;

            try {
                let q = query(collection(db, "users"), where("name_lower", "==", input.toLowerCase()));
                let snap = await getDocs(q);
                if(snap.empty) { q = query(collection(db, "users"), where("name", "==", input)); snap = await getDocs(q); }
                if(snap.empty) { q = query(collection(db, "users"), where("email", "==", input)); snap = await getDocs(q); }

                if(!snap.empty) {
                    const d = snap.docs[0];
                    targetUid = d.id;
                    targetName = d.data().name;
                    isBlocked = d.data().isBlocked || false;
                }

                if(targetUid) {
                    searchedUserUid = targetUid;
                    searchedUserIsBlocked = isBlocked;
                    document.getElementById('manageUserPanel').classList.remove('hidden');
                    document.getElementById('targetUserName').innerText = targetName;
                    
                    const blockBtn = document.getElementById('btnBlockUser');
                    blockBtn.innerText = isBlocked ? "UNBLOCK" : "BLOCK";
                    blockBtn.className = isBlocked ? "btn btn-success btn-sm fw-bold me-2" : "btn btn-warning btn-sm fw-bold me-2";
                    document.getElementById('targetUserStatus').innerText = isBlocked ? "BLOCKED" : "Active";
                    document.getElementById('targetUserStatus').className = isBlocked ? "text-danger fw-bold" : "text-success";

                    if(currentUserRole === 'MD') document.getElementById('btnDeleteUser').classList.remove('hidden');
                    else document.getElementById('btnDeleteUser').classList.add('hidden');

                    loadLogs(targetUid);
                } else {
                    document.getElementById('manageUserPanel').classList.add('hidden');
                    list.innerHTML = '<p class="text-center text-danger mt-4">User not found.</p>';
                }
            } catch(e) { console.error(e); }
        };

        window.resetSearch = () => {
            document.getElementById('searchInput').value = "";
            searchedUserUid = null;
            setupDashboard();
        };

        window.clearDateFilter = () => {
            document.getElementById('filterDate').value = "";
            loadLogs();
        };

        window.toggleBlockUser = async () => {
            if(!searchedUserUid) return;
            if(confirm("Toggle Block Status?")) {
                await updateDoc(doc(db, "users", searchedUserUid), { isBlocked: !searchedUserIsBlocked });
                searchUserAndLogs();
            }
        };

        // --- 8. LOAD LOGS (Clean Layout, Time Range, Date Filter) ---
        window.loadLogs = async (targetUid = null) => {
            const list = document.getElementById('logsList');
            const dateFilter = document.getElementById('filterDate').value;
            
            let uid = targetUid || searchedUserUid;
            if(!uid) {
                if(currentUserRole === 'MD') return; // MD clean by default
                uid = currentUserId; 
            }

            // Construct Query
            let q;
            if (dateFilter) {
                // Filter by specific Date String
                q = query(collection(db, "work_logs"), 
                    where("uid", "==", uid), 
                    where("dateString", "==", dateFilter), 
                    orderBy("timestamp", "desc"));
            } else {
                // Show All
                q = query(collection(db, "work_logs"), 
                    where("uid", "==", uid), 
                    orderBy("timestamp", "desc"));
            }
            
            try {
                const snap = await getDocs(q);
                list.innerHTML = '';

                if(snap.empty) {
                    list.innerHTML = '<p class="text-muted text-center mt-4">No logs found for this selection.</p>';
                    return;
                }

                snap.forEach(d => {
                    const data = d.data();
                    const dateDisplay = data.timestamp ? data.timestamp.toDate().toLocaleDateString() : '';
                    
                    // CLEAN UI: No Name, Time Range shown
                    list.innerHTML += `
                        <div class="card log-card p-3 shadow-sm">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="badge bg-secondary mb-1">${dateDisplay}</span>
                                    <h6 class="mb-0 fw-bold text-dark">${data.startTime} - ${data.endTime}</h6>
                                </div>
                                <span class="badge bg-primary fs-6">${data.duration} Hrs</span>
                            </div>
                            <div class="mt-2 pt-2 border-top">
                                <p class="mb-0 text-secondary">${data.description}</p>
                            </div>
                        </div>
                    `;
                });
            } catch(e) {
                console.error(e);
                list.innerHTML = '<p class="text-danger">Error. Note: Date filtering requires a Firestore Index. Check Console if this fails.</p>';
                if(e.message.includes("index")) alert("Admin: Create index via Console link (F12).");
            }
        };

        // --- 9. DELETE EMPLOYEE ---
        window.deleteEntireEmployee = async () => {
            if(!searchedUserUid || currentUserRole !== 'MD') return;
            if(confirm("‚ö† WARNING: DELETE USER & ALL DATA?")) {
                try {
                    await deleteDoc(doc(db, "users", searchedUserUid));
                    const q = query(collection(db, "work_logs"), where("uid", "==", searchedUserUid));
                    const snap = await getDocs(q);
                    const batch = writeBatch(db);
                    snap.forEach(d => batch.delete(d.ref));
                    await batch.commit();
                    alert("User Deleted.");
                    resetSearch();
                } catch(e) { alert("Error: " + e.message); }
            }
        };
    </script>
</body>
</html>
