<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Hourly Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; }
        .hidden { display: none !important; }
        .login-container { max-width: 400px; margin: 100px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .log-card { border-left: 5px solid #0d6efd; margin-bottom: 10px; }
        .role-badge { font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; }
        .admin-card { border-top: 4px solid #ffc107; }
    </style>
</head>
<body>

    <div id="loginSection" class="container login-container">
        <h3 class="text-center mb-4">Work Tracker Login</h3>
        <form id="loginForm">
            <div class="mb-3">
                <label>Email ID</label>
                <input type="email" id="loginEmail" class="form-control" required placeholder="id@company.com">
            </div>
            <div class="mb-3">
                <label>Password</label>
                <input type="password" id="loginPass" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Login</button>
        </form>
    </div>

    <div id="dashboardSection" class="container mt-4 hidden">
        <nav class="navbar navbar-light bg-white p-3 rounded shadow-sm justify-content-between mb-4">
            <span class="navbar-brand mb-0 h1">
                Welcome, <span id="userNameDisplay">User</span> 
                <span class="badge bg-secondary role-badge" id="userRoleDisplay">...</span>
            </span>
            <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
        </nav>

        <div class="row">
            <div class="col-md-4">
                
                <div id="logWorkCard" class="card p-3 mb-3">
                    <h5>üìù Log My Work</h5>
                    <form id="workForm">
                        <div class="mb-2">
                            <label>Duration (Hours)</label>
                            <input type="number" id="workDuration" step="0.5" class="form-control" required>
                        </div>
                        <div class="mb-2">
                            <label>Description</label>
                            <textarea id="workDesc" class="form-control" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Submit Log</button>
                    </form>
                </div>

                <div id="adminToolsCard" class="card p-3 mb-3 admin-card hidden">
                    <h5 class="text-warning">‚ö° Create New User</h5>
                    <p class="small text-muted">System will not logout after creation.</p>
                    <input type="email" id="newEmail" class="form-control mb-2" placeholder="New Email">
                    <input type="password" id="newPass" class="form-control mb-2" placeholder="New Password">
                    <input type="text" id="newName" class="form-control mb-2" placeholder="Full Name">
                    
                    <select id="newRole" class="form-select mb-2">
                        <option value="Employee">Employee</option>
                        </select>
                    
                    <button onclick="createNewUser()" class="btn btn-warning w-100">Create User</button>
                </div>
            </div>

            <div class="col-md-8">
                
                <div id="searchPanel" class="card p-3 mb-3 hidden bg-light">
                    <label class="form-label fw-bold">üîç Search Employee Work</label>
                    <div class="input-group">
                        <input type="text" id="searchInput" class="form-control" placeholder="Enter Exact Name or User ID...">
                        <button class="btn btn-primary" onclick="searchLogs()">Search</button>
                        <button class="btn btn-outline-secondary" onclick="resetSearch()">Clear</button>
                    </div>
                    <small class="text-muted">MD View: Search to see data. HR View: Search to see others.</small>
                </div>

                <div class="card p-3">
                    <div class="d-flex justify-content-between">
                        <h5 id="listTitle">Work History</h5>
                        <button class="btn btn-sm btn-light" onclick="loadLogs()">Refresh List</button>
                    </div>
                    <hr>
                    <div id="logsList" style="max-height: 600px; overflow-y: auto;">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, doc, getDoc, setDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- PASTE YOUR CONFIG HERE ---
        const firebaseConfig = {
          apiKey: "AIzaSyAgmgOG0I5p2VsedQXorr4xq7fvKOvPRCY",
          authDomain: "work-sheet-4e4b0.firebaseapp.com",
          projectId: "work-sheet-4e4b0",
          storageBucket: "work-sheet-4e4b0.firebasestorage.app",
          messagingSenderId: "370834015544",
          appId: "1:370834015544:web:0dc081da38c9d39dc56dcd",
          measurementId: "G-HH40E4PMM1"
        };

        // Main App Instance
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserRole = null;
        let currentUserId = null;

        // --- LOGIN LOGIC ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                alert("Login failed: " + error.message);
            }
        });

        window.logout = () => signOut(auth);

        // --- AUTH LISTENER ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('dashboardSection').classList.remove('hidden');
                currentUserId = user.uid;
                
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    currentUserRole = userData.role;
                    
                    document.getElementById('userNameDisplay').innerText = userData.name;
                    document.getElementById('userRoleDisplay').innerText = currentUserRole;
                    
                    setupUI();
                }
            } else {
                document.getElementById('loginSection').classList.remove('hidden');
                document.getElementById('dashboardSection').classList.add('hidden');
            }
        });

        // --- UI SETUP BASED ON ROLE ---
        function setupUI() {
            const logCard = document.getElementById('logWorkCard');
            const adminCard = document.getElementById('adminToolsCard');
            const searchPanel = document.getElementById('searchPanel');
            const roleSelect = document.getElementById('newRole');
            
            // Default states
            logCard.classList.remove('hidden');
            adminCard.classList.add('hidden');
            searchPanel.classList.add('hidden');
            roleSelect.innerHTML = '<option value="Employee">Employee</option>';

            // 1. MD LOGIC
            if (currentUserRole === 'MD') {
                logCard.classList.add('hidden'); // MD doesn't log work
                adminCard.classList.remove('hidden'); // Can create users
                searchPanel.classList.remove('hidden'); // Can search
                roleSelect.innerHTML += '<option value="HR">HR</option>';
                
                // MD sees nothing initially (Clean Dashboard)
                document.getElementById('logsList').innerHTML = '<p class="text-muted text-center mt-4">Enter a Name or ID above to view work progress.</p>';
                return; 
            }

            // 2. HR LOGIC
            if (currentUserRole === 'HR') {
                adminCard.classList.remove('hidden'); // Can create Employees
                searchPanel.classList.remove('hidden'); // Can search
                // HR sees their own logs by default
                loadLogs(); 
            }

            // 3. EMPLOYEE LOGIC
            if (currentUserRole === 'Employee') {
                // Default is fine (Log Card Visible, Admin/Search Hidden)
                loadLogs();
            }
        }

        // --- CREATE USER (NO LOGOUT FIX) ---
        window.createNewUser = async () => {
            const email = document.getElementById('newEmail').value;
            const pass = document.getElementById('newPass').value;
            const name = document.getElementById('newName').value;
            const role = document.getElementById('newRole').value;

            if(!email || !pass || !name) return alert("Fill all fields");

            if(currentUserRole === 'Employee') return alert("Unauthorized");
            if(currentUserRole === 'HR' && role === 'HR') return alert("HR cannot create HR");

            const currentAdminEmail = auth.currentUser.email; 
            
            if(confirm(`Create ${role}: ${name}?`)) {
                try {
                    // TRICK: Create a secondary app instance to create user without logging out main admin
                    const secondaryApp = initializeApp(firebaseConfig, "SecondaryApp");
                    const secondaryAuth = getAuth(secondaryApp);
                    
                    const userCred = await createUserWithEmailAndPassword(secondaryAuth, email, pass);
                    
                    // Write to DB using MAIN app connection
                    await setDoc(doc(db, "users", userCred.user.uid), {
                        name: name,
                        role: role,
                        email: email,
                        createdBy: currentAdminEmail
                    });

                    // Cleanup secondary app
                    await signOut(secondaryAuth);
                    await deleteApp(secondaryApp);

                    alert("User Created Successfully! You can continue working.");
                    
                    // Clear fields
                    document.getElementById('newEmail').value = "";
                    document.getElementById('newPass').value = "";
                    document.getElementById('newName').value = "";

                } catch (e) {
                    alert("Error: " + e.message);
                }
            }
        };

        // --- SUBMIT WORK ---
        document.getElementById('workForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const duration = document.getElementById('workDuration').value;
            const desc = document.getElementById('workDesc').value;

            try {
                await addDoc(collection(db, "work_logs"), {
                    uid: currentUserId,
                    name: document.getElementById('userNameDisplay').innerText,
                    duration: duration,
                    description: desc,
                    timestamp: serverTimestamp()
                });
                document.getElementById('workForm').reset();
                if(currentUserRole !== 'MD') loadLogs(); // Refresh if not MD
            } catch (error) {
                alert("Error submitting: " + error.message);
            }
        });

        // --- SEARCH LOGIC ---
        window.searchLogs = async () => {
            const term = document.getElementById('searchInput').value.trim();
            if(!term) return alert("Please enter a name or ID");
            loadLogs(term);
        }

        window.resetSearch = () => {
            document.getElementById('searchInput').value = "";
            if(currentUserRole === 'MD') {
                 document.getElementById('logsList').innerHTML = '<p class="text-muted text-center mt-4">Enter a Name or ID above to view work progress.</p>';
            } else {
                loadLogs(); // HR/Employee go back to own logs
            }
        }

        // --- LOAD LOGS (With Search Filter) ---
        window.loadLogs = async (searchTerm = null) => {
            const list = document.getElementById('logsList');
            list.innerHTML = '<p>Loading...</p>';
            
            let q;
            const logsRef = collection(db, "work_logs");

            // 1. IF SEARCHING (For HR/MD)
            if (searchTerm && (currentUserRole === 'HR' || currentUserRole === 'MD')) {
                // Try searching by exact Name first
                q = query(logsRef, where("name", "==", searchTerm), orderBy("timestamp", "desc"));
                // Note: If you want to search by UID, you'd swap "name" for "uid"
            } 
            // 2. EMPLOYEE (Always own logs)
            else if (currentUserRole === 'Employee') {
                q = query(logsRef, where("uid", "==", currentUserId), orderBy("timestamp", "desc"));
            }
            // 3. HR DEFAULT (Own logs)
            else if (currentUserRole === 'HR') {
                q = query(logsRef, where("uid", "==", currentUserId), orderBy("timestamp", "desc"));
            }
            // 4. MD DEFAULT (Clean - handled in setupUI, but if triggered manually:)
            else if (currentUserRole === 'MD') {
                 list.innerHTML = '<p class="text-muted text-center mt-4">Please use the Search Bar.</p>';
                 return;
            }

            try {
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    list.innerHTML = '<p class="text-muted">No logs found.</p>';
                    return;
                }

                list.innerHTML = '';
                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const date = data.timestamp ? data.timestamp.toDate().toLocaleString() : 'Just now';
                    
                    let deleteBtn = '';
                    if (currentUserRole === 'MD') {
                        deleteBtn = `<button class="btn btn-danger btn-sm float-end" onclick="deleteLog('${docSnap.id}')">Delete</button>`;
                    }

                    const html = `
                        <div class="card log-card p-2 shadow-sm">
                            <div class="d-flex justify-content-between">
                                <strong>${data.name} <span class="text-muted small">(${date})</span></strong>
                                <span class="badge bg-primary">${data.duration} Hrs</span>
                            </div>
                            <p class="mb-0 mt-1">${data.description}</p>
                            ${deleteBtn}
                        </div>
                    `;
                    list.innerHTML += html;
                });
            } catch (e) {
                console.error(e);
                list.innerHTML = `<p class="text-danger">Search Error: ${e.message}</p>`;
                // Fallback for indexing errors
                if(e.message.includes("requires an index")) {
                    alert("Admin Note: First search might fail. Check browser console for the Index Link from Firebase.");
                }
            }
        };

        window.deleteLog = async (id) => {
            if (currentUserRole !== 'MD') return;
            if (confirm("Delete this log permanently?")) {
                await deleteDoc(doc(db, "work_logs", id));
                // Refresh based on what we are currently viewing
                const term = document.getElementById('searchInput').value;
                loadLogs(term); 
            }
        }
    </script>
</body>
</html>
