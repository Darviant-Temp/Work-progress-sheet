<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Hourly Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; }
        .hidden { display: none !important; }
        .login-container { max-width: 400px; margin: 100px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .log-card { border-left: 5px solid #0d6efd; margin-bottom: 10px; }
        .role-badge { font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>
<body>

    <div id="loginSection" class="container login-container">
        <h3 class="text-center mb-4">Work Tracker Login</h3>
        <form id="loginForm">
            <div class="mb-3">
                <label>Email ID</label>
                <input type="email" id="loginEmail" class="form-control" required placeholder="id@company.com">
            </div>
            <div class="mb-3">
                <label>Password</label>
                <input type="password" id="loginPass" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Login</button>
        </form>
    </div>

    <div id="dashboardSection" class="container mt-4 hidden">
        <nav class="navbar navbar-light bg-white p-3 rounded shadow-sm justify-content-between mb-4">
            <span class="navbar-brand mb-0 h1">
                Welcome, <span id="userNameDisplay">User</span> 
                <span class="badge bg-secondary role-badge" id="userRoleDisplay">...</span>
            </span>
            <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
        </nav>

        <div class="row">
            <div class="col-md-4">
                <div class="card p-3 mb-3">
                    <h5>üìù Log Work</h5>
                    <form id="workForm">
                        <div class="mb-2">
                            <label>Duration (Hours)</label>
                            <input type="number" id="workDuration" step="0.5" class="form-control" required>
                        </div>
                        <div class="mb-2">
                            <label>Description</label>
                            <textarea id="workDesc" class="form-control" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Submit Log (Permanent)</button>
                    </form>
                </div>

                <div id="adminPanel" class="card p-3 mb-3 border-warning hidden">
                    <h5 class="text-warning">‚ö° Admin Panel</h5>
                    <p class="small text-muted">Add new employee/HR credentials.</p>
                    <input type="email" id="newEmail" class="form-control mb-2" placeholder="New Email">
                    <input type="password" id="newPass" class="form-control mb-2" placeholder="New Password">
                    <input type="text" id="newName" class="form-control mb-2" placeholder="Full Name">
                    
                    <select id="newRole" class="form-select mb-2">
                        <option value="Employee">Employee</option>
                        </select>
                    
                    <button onclick="createNewUser()" class="btn btn-warning w-100">Create User</button>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card p-3">
                    <div class="d-flex justify-content-between">
                        <h5>Work History</h5>
                        <button class="btn btn-sm btn-light" onclick="loadLogs()">Refresh</button>
                    </div>
                    <hr>
                    <div id="logsList" style="max-height: 600px; overflow-y: auto;">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, doc, getDoc, setDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- YOUR CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyAgmgOG0I5p2VsedQXorr4xq7fvKOvPRCY",
          authDomain: "work-sheet-4e4b0.firebaseapp.com",
          projectId: "work-sheet-4e4b0",
          storageBucket: "work-sheet-4e4b0.firebasestorage.app",
          messagingSenderId: "370834015544",
          appId: "1:370834015544:web:0dc081da38c9d39dc56dcd",
          measurementId: "G-HH40E4PMM1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserRole = null;
        let currentUserId = null;

        // --- AUTHENTICATION ---
        const loginForm = document.getElementById('loginForm');
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                alert("Login failed: " + error.message);
            }
        });

        window.logout = () => signOut(auth);

        // --- AUTH STATE LISTENER ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('dashboardSection').classList.remove('hidden');
                currentUserId = user.uid;
                
                // Fetch Role
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    currentUserRole = userData.role; // 'Employee', 'HR', 'MD'
                    
                    document.getElementById('userNameDisplay').innerText = userData.name;
                    document.getElementById('userRoleDisplay').innerText = currentUserRole;
                    
                    setupUIBasedOnRole();
                    loadLogs();
                } else {
                    alert("User profile not found. Please contact Admin.");
                }
            } else {
                document.getElementById('loginSection').classList.remove('hidden');
                document.getElementById('dashboardSection').classList.add('hidden');
            }
        });

        // --- ROLE BASED UI ---
        function setupUIBasedOnRole() {
            const adminPanel = document.getElementById('adminPanel');
            const roleSelect = document.getElementById('newRole');
            
            // Clean slate options
            roleSelect.innerHTML = '<option value="Employee">Employee</option>';

            if (currentUserRole === 'MD') {
                adminPanel.classList.remove('hidden');
                roleSelect.innerHTML += '<option value="HR">HR</option>'; // MD can add HRs
            } else if (currentUserRole === 'HR') {
                adminPanel.classList.remove('hidden');
                // HR cannot see 'HR' option, only Employee
            } else {
                adminPanel.classList.add('hidden');
            }
        }

        // --- LOGIC: CREATE NEW USER ---
        window.createNewUser = async () => {
            const email = document.getElementById('newEmail').value;
            const pass = document.getElementById('newPass').value;
            const name = document.getElementById('newName').value;
            const role = document.getElementById('newRole').value;

            if(!email || !pass || !name) return alert("Fill all fields");

            // Security check
            if(currentUserRole === 'Employee') return alert("Unauthorized");
            if(currentUserRole === 'HR' && role === 'HR') return alert("HR cannot create HR");

            const currentAdminEmail = auth.currentUser.email; 
            
            if(confirm(`This will create ${role}: ${name}. Proceed?`)) {
                try {
                    // 1. Create Auth User (This logs us out!)
                    const userCred = await createUserWithEmailAndPassword(auth, email, pass);
                    
                    // 2. Write User Profile to Database
                    await setDoc(doc(db, "users", userCred.user.uid), {
                        name: name,
                        role: role,
                        email: email,
                        createdBy: currentAdminEmail
                    });

                    alert("User Created! You have been logged out (Security Protocol). Please log back in as Admin.");
                    window.location.reload(); 
                } catch (e) {
                    alert("Error: " + e.message);
                }
            }
        };

        // --- LOGIC: SUBMIT WORK ---
        document.getElementById('workForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const duration = document.getElementById('workDuration').value;
            const desc = document.getElementById('workDesc').value;

            try {
                await addDoc(collection(db, "work_logs"), {
                    uid: currentUserId,
                    name: document.getElementById('userNameDisplay').innerText,
                    duration: duration,
                    description: desc,
                    timestamp: serverTimestamp()
                });
                document.getElementById('workForm').reset();
                loadLogs(); // Refresh list
            } catch (error) {
                alert("Error submitting: " + error.message);
            }
        });

        // --- LOGIC: LOAD LOGS ---
        window.loadLogs = async () => {
            const list = document.getElementById('logsList');
            list.innerHTML = '<p>Loading...</p>';
            
            let q;
            // Employees see only their own. HR/MD see all.
            if (currentUserRole === 'Employee') {
                q = query(collection(db, "work_logs"), where("uid", "==", currentUserId), orderBy("timestamp", "desc"));
            } else {
                q = query(collection(db, "work_logs"), orderBy("timestamp", "desc"));
            }

            try {
                const querySnapshot = await getDocs(q);
                list.innerHTML = '';
                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const date = data.timestamp ? data.timestamp.toDate().toLocaleString() : 'Just now';
                    
                    // Delete Button (MD Only)
                    let deleteBtn = '';
                    if (currentUserRole === 'MD') {
                        deleteBtn = `<button class="btn btn-danger btn-sm float-end" onclick="deleteLog('${docSnap.id}')">Delete</button>`;
                    }

                    const html = `
                        <div class="card log-card p-2 shadow-sm">
                            <div class="d-flex justify-content-between">
                                <strong>${data.name} <span class="text-muted small">(${date})</span></strong>
                                <span class="badge bg-primary">${data.duration} Hrs</span>
                            </div>
                            <p class="mb-0 mt-1">${data.description}</p>
                            ${deleteBtn}
                        </div>
                    `;
                    list.innerHTML += html;
                });
            } catch (e) {
                console.error(e);
                list.innerHTML = `<p class="text-danger">Access Denied: You do not have permission to view these logs.</p>`;
            }
        };

        // --- LOGIC: DELETE LOG (MD ONLY) ---
        window.deleteLog = async (id) => {
            if (currentUserRole !== 'MD') return;

            // Double Confirmation
            if (confirm("Are you sure you want to delete this log?")) {
                if (confirm("FINAL WARNING: This cannot be undone. Delete permanently?")) {
                    try {
                        await deleteDoc(doc(db, "work_logs", id));
                        loadLogs();
                    } catch (e) {
                        alert("Error: " + e.message);
                    }
                }
            }
        }
    </script>
</body>
</html>
