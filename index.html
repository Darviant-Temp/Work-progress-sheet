<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Hourly Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; }
        .hidden { display: none !important; }
        .login-container { max-width: 400px; margin: 100px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .log-card { border-left: 5px solid #0d6efd; margin-bottom: 10px; }
        .role-badge { font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; }
        .admin-card { border-top: 4px solid #ffc107; }
        .delete-zone { border: 2px dashed #dc3545; background-color: #fff5f5; }
    </style>
</head>
<body>

    <div id="loginSection" class="container login-container">
        <h3 class="text-center mb-4">Work Tracker Login</h3>
        <form id="loginForm">
            <div class="mb-3">
                <label>Email ID</label>
                <input type="email" id="loginEmail" class="form-control" required placeholder="id@company.com">
            </div>
            <div class="mb-3">
                <label>Password</label>
                <input type="password" id="loginPass" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Login</button>
        </form>
    </div>

    <div id="dashboardSection" class="container mt-4 hidden">
        <nav class="navbar navbar-light bg-white p-3 rounded shadow-sm justify-content-between mb-4">
            <span class="navbar-brand mb-0 h1">
                Welcome, <span id="userNameDisplay">User</span> 
                <span class="badge bg-secondary role-badge" id="userRoleDisplay">...</span>
            </span>
            <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
        </nav>

        <div class="row">
            <div class="col-md-4">
                
                <div id="logWorkCard" class="card p-3 mb-3">
                    <h5>üìù Log My Work</h5>
                    <form id="workForm">
                        <div class="mb-2">
                            <label>Duration (Hours)</label>
                            <input type="number" id="workDuration" step="0.5" class="form-control" required>
                        </div>
                        <div class="mb-2">
                            <label>Description</label>
                            <textarea id="workDesc" class="form-control" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Submit Log</button>
                    </form>
                </div>

                <div id="adminToolsCard" class="card p-3 mb-3 admin-card hidden">
                    <h5 class="text-warning">‚ö° Create New User</h5>
                    <p class="small text-muted">System will not logout after creation.</p>
                    <input type="email" id="newEmail" class="form-control mb-2" placeholder="New Email">
                    <input type="password" id="newPass" class="form-control mb-2" placeholder="New Password">
                    <input type="text" id="newName" class="form-control mb-2" placeholder="Full Name">
                    
                    <select id="newRole" class="form-select mb-2">
                        <option value="Employee">Employee</option>
                        </select>
                    
                    <button onclick="createNewUser()" class="btn btn-warning w-100">Create User</button>
                </div>
            </div>

            <div class="col-md-8">
                
                <div id="searchPanel" class="card p-3 mb-3 hidden bg-light">
                    <label class="form-label fw-bold">üîç Search Employee</label>
                    <div class="input-group">
                        <input type="text" id="searchInput" class="form-control" placeholder="Enter Name (Case insensitive)...">
                        <button class="btn btn-primary" onclick="searchUserAndLogs()">Search</button>
                        <button class="btn btn-outline-secondary" onclick="resetSearch()">Clear</button>
                    </div>
                </div>

                <div id="deleteUserPanel" class="card p-3 mb-3 delete-zone hidden">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="text-danger m-0">üõë User Found: <span id="targetUserName">...</span></h5>
                            <small class="text-muted">ID: <span id="targetUserId">...</span></small>
                        </div>
                        <button onclick="deleteEntireEmployee()" class="btn btn-danger fw-bold">DELETE EMPLOYEE & DATA</button>
                    </div>
                    <small class="text-danger mt-2">Warning: This will delete the user profile AND all their work logs permanently.</small>
                </div>

                <div class="card p-3">
                    <div class="d-flex justify-content-between">
                        <h5 id="listTitle">Work History</h5>
                        <button class="btn btn-sm btn-light" onclick="loadLogs()">Refresh List</button>
                    </div>
                    <hr>
                    <div id="logsList" style="max-height: 600px; overflow-y: auto;">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, doc, getDoc, setDoc, deleteDoc, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- PASTE YOUR CONFIG HERE ---
        const firebaseConfig = {
          apiKey: "AIzaSyAgmgOG0I5p2VsedQXorr4xq7fvKOvPRCY",
          authDomain: "work-sheet-4e4b0.firebaseapp.com",
          projectId: "work-sheet-4e4b0",
          storageBucket: "work-sheet-4e4b0.firebasestorage.app",
          messagingSenderId: "370834015544",
          appId: "1:370834015544:web:0dc081da38c9d39dc56dcd",
          measurementId: "G-HH40E4PMM1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserRole = null;
        let currentUserId = null;
        let searchedUserUid = null; // Store ID for deletion

        // --- LOGIN ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            try { await signInWithEmailAndPassword(auth, email, pass); } 
            catch (error) { alert("Login failed: " + error.message); }
        });

        window.logout = () => signOut(auth);

        // --- AUTH STATE ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('dashboardSection').classList.remove('hidden');
                currentUserId = user.uid;
                
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    currentUserRole = userData.role;
                    document.getElementById('userNameDisplay').innerText = userData.name;
                    document.getElementById('userRoleDisplay').innerText = currentUserRole;
                    setupUI();
                }
            } else {
                document.getElementById('loginSection').classList.remove('hidden');
                document.getElementById('dashboardSection').classList.add('hidden');
            }
        });

        // --- UI SETUP ---
        function setupUI() {
            const logCard = document.getElementById('logWorkCard');
            const adminCard = document.getElementById('adminToolsCard');
            const searchPanel = document.getElementById('searchPanel');
            const roleSelect = document.getElementById('newRole');
            
            // Reset
            logCard.classList.remove('hidden');
            adminCard.classList.add('hidden');
            searchPanel.classList.add('hidden');
            document.getElementById('deleteUserPanel').classList.add('hidden');
            roleSelect.innerHTML = '<option value="Employee">Employee</option>';

            if (currentUserRole === 'MD') {
                logCard.classList.add('hidden');
                adminCard.classList.remove('hidden');
                searchPanel.classList.remove('hidden');
                roleSelect.innerHTML += '<option value="HR">HR</option>';
                document.getElementById('logsList').innerHTML = '<p class="text-muted text-center mt-4">Search for an Employee to view/manage.</p>';
                return;
            }

            if (currentUserRole === 'HR') {
                adminCard.classList.remove('hidden');
                searchPanel.classList.remove('hidden');
                loadLogs(); 
            }

            if (currentUserRole === 'Employee') {
                loadLogs();
            }
        }

        // --- CREATE USER (With Lowercase Name) ---
        window.createNewUser = async () => {
            const email = document.getElementById('newEmail').value;
            const pass = document.getElementById('newPass').value;
            const name = document.getElementById('newName').value;
            const role = document.getElementById('newRole').value;

            if(!email || !pass || !name) return alert("Fill all fields");

            if(confirm(`Create ${role}: ${name}?`)) {
                try {
                    const secondaryApp = initializeApp(firebaseConfig, "SecondaryApp");
                    const secondaryAuth = getAuth(secondaryApp);
                    const userCred = await createUserWithEmailAndPassword(secondaryAuth, email, pass);
                    
                    await setDoc(doc(db, "users", userCred.user.uid), {
                        name: name,
                        name_lower: name.toLowerCase(), // Helper for search
                        role: role,
                        email: email
                    });

                    await signOut(secondaryAuth);
                    await deleteApp(secondaryApp);

                    alert("User Created Successfully!");
                    document.getElementById('newName').value = "";
                    document.getElementById('newEmail').value = "";
                    document.getElementById('newPass').value = "";
                } catch (e) { alert("Error: " + e.message); }
            }
        };

        // --- SUBMIT WORK (With Lowercase Name) ---
        document.getElementById('workForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const duration = document.getElementById('workDuration').value;
            const desc = document.getElementById('workDesc').value;
            const name = document.getElementById('userNameDisplay').innerText;

            try {
                await addDoc(collection(db, "work_logs"), {
                    uid: currentUserId,
                    name: name,
                    name_lower: name.toLowerCase(), // Helper for search
                    duration: duration,
                    description: desc,
                    timestamp: serverTimestamp()
                });
                document.getElementById('workForm').reset();
                if(currentUserRole !== 'MD') loadLogs(); 
            } catch (error) { alert("Error: " + error.message); }
        });

        // --- SEARCH (USER FIRST, THEN LOGS) ---
        window.searchUserAndLogs = async () => {
            const rawTerm = document.getElementById('searchInput').value.trim();
            if(!rawTerm) return;
            
            const term = rawTerm.toLowerCase(); // Case insensitive
            const deletePanel = document.getElementById('deleteUserPanel');
            const list = document.getElementById('logsList');
            
            list.innerHTML = '<p>Searching...</p>';
            deletePanel.classList.add('hidden');
            searchedUserUid = null;

            // 1. Find the User ID from the 'users' collection
            let targetUid = null;
            let targetName = null;

            try {
                // Search by name_lower
                const userQuery = query(collection(db, "users"), where("name_lower", "==", term));
                const userSnap = await getDocs(userQuery);

                if (!userSnap.empty) {
                    const uDoc = userSnap.docs[0];
                    targetUid = uDoc.id;
                    targetName = uDoc.data().name;
                } else {
                    // Fallback: Try searching by Email
                    const emailQuery = query(collection(db, "users"), where("email", "==", rawTerm));
                    const emailSnap = await getDocs(emailQuery);
                    if(!emailSnap.empty) {
                        targetUid = emailSnap.docs[0].id;
                        targetName = emailSnap.docs[0].data().name;
                    }
                }

                if (targetUid) {
                    // User Found!
                    if (currentUserRole === 'MD') {
                        searchedUserUid = targetUid;
                        document.getElementById('targetUserName').innerText = targetName;
                        document.getElementById('targetUserId').innerText = targetUid;
                        deletePanel.classList.remove('hidden');
                    }
                    // Load their logs
                    loadLogs(targetUid);
                } else {
                    list.innerHTML = '<p class="text-danger">User not found. Try exact email or ensure Name matches.</p>';
                }

            } catch(e) {
                console.error(e);
                list.innerHTML = `<p class="text-danger">Error: ${e.message}</p>`;
                if(e.message.includes("index")) alert("System Note: Firebase is building the new index. Wait 2 minutes.");
            }
        }

        window.resetSearch = () => {
            document.getElementById('searchInput').value = "";
            document.getElementById('deleteUserPanel').classList.add('hidden');
            searchedUserUid = null;
            if(currentUserRole === 'MD') {
                 document.getElementById('logsList').innerHTML = '<p class="text-muted text-center mt-4">Search to view data.</p>';
            } else {
                loadLogs(); 
            }
        }

        // --- LOAD LOGS ---
        window.loadLogs = async (targetUid = null) => {
            const list = document.getElementById('logsList');
            let q;
            const logsRef = collection(db, "work_logs");

            // Define who we are looking for
            const uidToFetch = targetUid || currentUserId;

            if (currentUserRole === 'MD' && !targetUid) {
                // MD with no search = show nothing
                return;
            }

            // Query by UID (Fast and Secure)
            q = query(logsRef, where("uid", "==", uidToFetch), orderBy("timestamp", "desc"));

            try {
                const querySnapshot = await getDocs(q);
                list.innerHTML = '';
                
                if (querySnapshot.empty) {
                    list.innerHTML = '<p class="text-muted">No work logs found for this user.</p>';
                    return;
                }

                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const date = data.timestamp ? data.timestamp.toDate().toLocaleString() : 'Just now';
                    
                    const html = `
                        <div class="card log-card p-2 shadow-sm">
                            <div class="d-flex justify-content-between">
                                <strong>${data.name} <span class="text-muted small">(${date})</span></strong>
                                <span class="badge bg-primary">${data.duration} Hrs</span>
                            </div>
                            <p class="mb-0 mt-1">${data.description}</p>
                        </div>
                    `;
                    list.innerHTML += html;
                });
            } catch (e) {
                list.innerHTML = `<p class="text-danger">Access Error: ${e.message}</p>`;
            }
        };

        // --- DELETE ENTIRE EMPLOYEE (MD ONLY) ---
        window.deleteEntireEmployee = async () => {
            if (!searchedUserUid || currentUserRole !== 'MD') return;

            const name = document.getElementById('targetUserName').innerText;
            if (confirm(`‚ö† EXTREME DANGER ‚ö†\n\nAre you sure you want to delete Employee: ${name}?\n\n1. Their login will be blocked.\n2. All their work history will be ERASED.\n3. This cannot be undone.`)) {
                
                try {
                    // 1. Delete User Profile
                    await deleteDoc(doc(db, "users", searchedUserUid));

                    // 2. Delete All Logs (Loop and delete)
                    const q = query(collection(db, "work_logs"), where("uid", "==", searchedUserUid));
                    const snapshot = await getDocs(q);
                    
                    const batch = writeBatch(db);
                    snapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();

                    alert(`Employee ${name} has been deleted.`);
                    resetSearch();

                } catch (e) {
                    alert("Error during deletion: " + e.message);
                }
            }
        }
    </script>
</body>
</html>
