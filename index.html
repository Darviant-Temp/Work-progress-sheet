<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Hourly Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; }
        .hidden { display: none !important; }
        .login-container { max-width: 400px; margin: 100px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .log-card { border-left: 5px solid #0d6efd; margin-bottom: 10px; }
        .role-badge { font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; }
        .admin-card { border-top: 4px solid #ffc107; }
        .delete-zone { border: 2px solid #dee2e6; background-color: #fff; padding: 15px; border-radius: 8px; }
    </style>
</head>
<body>

    <div id="loginSection" class="container login-container">
        <h3 class="text-center mb-4">Work Tracker Login</h3>
        <form id="loginForm">
            <div class="mb-3">
                <label>Email ID</label>
                <input type="email" id="loginEmail" class="form-control" required placeholder="id@company.com">
            </div>
            <div class="mb-3">
                <label>Password</label>
                <input type="password" id="loginPass" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Login</button>
        </form>
    </div>

    <div id="dashboardSection" class="container mt-4 hidden">
        <nav class="navbar navbar-light bg-white p-3 rounded shadow-sm justify-content-between mb-4">
            <span class="navbar-brand mb-0 h1">
                Welcome, <span id="userNameDisplay">User</span> 
                <span class="badge bg-secondary role-badge" id="userRoleDisplay">...</span>
            </span>
            <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
        </nav>

        <div class="row">
            <div class="col-md-4">
                
                <div id="logWorkCard" class="card p-3 mb-3">
                    <h5>üìù Log My Work</h5>
                    <form id="workForm">
                        <div class="mb-2">
                            <label>Duration (Hours)</label>
                            <input type="number" id="workDuration" step="0.5" class="form-control" required>
                        </div>
                        <div class="mb-2">
                            <label>Description</label>
                            <textarea id="workDesc" class="form-control" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Submit Log</button>
                    </form>
                </div>

                <div id="adminToolsCard" class="card p-3 mb-3 admin-card hidden">
                    <h5 class="text-warning">‚ö° Create New User</h5>
                    <p class="small text-muted">System will not logout after creation.</p>
                    <input type="email" id="newEmail" class="form-control mb-2" placeholder="New Email">
                    <input type="password" id="newPass" class="form-control mb-2" placeholder="New Password">
                    <input type="text" id="newName" class="form-control mb-2" placeholder="Full Name">
                    
                    <select id="newRole" class="form-select mb-2">
                        <option value="Employee">Employee</option>
                        </select>
                    
                    <button onclick="createNewUser()" class="btn btn-warning w-100">Create User</button>
                </div>
            </div>

            <div class="col-md-8">
                
                <div id="searchPanel" class="card p-3 mb-3 hidden bg-light">
                    <label class="form-label fw-bold">üîç Search Employee Work</label>
                    <div class="input-group">
                        <input type="text" id="searchInput" class="form-control" placeholder="Enter Name or Email...">
                        <button class="btn btn-primary" onclick="searchUserAndLogs()">Search</button>
                        <button class="btn btn-outline-secondary" onclick="resetSearch()">Clear</button>
                    </div>
                </div>

                <div id="manageUserPanel" class="delete-zone mb-3 hidden">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="m-0">User: <span id="targetUserName" class="fw-bold">...</span></h5>
                            <small class="text-muted">Status: <span id="targetUserStatus">Active</span></small>
                        </div>
                        <div>
                            <button id="btnBlockUser" onclick="toggleBlockUser()" class="btn btn-warning fw-bold me-2">Block Access</button>
                            
                            <button id="btnDeleteUser" onclick="deleteEntireEmployee()" class="btn btn-danger fw-bold hidden">DELETE DATA</button>
                        </div>
                    </div>
                </div>

                <div class="card p-3">
                    <div class="d-flex justify-content-between">
                        <h5 id="listTitle">Work History</h5>
                        <button class="btn btn-sm btn-light" onclick="loadLogs()">Refresh List</button>
                    </div>
                    <hr>
                    <div id="logsList" style="max-height: 600px; overflow-y: auto;">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, doc, getDoc, setDoc, updateDoc, deleteDoc, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- PASTE YOUR CONFIG HERE ---
        const firebaseConfig = {
          apiKey: "AIzaSyAgmgOG0I5p2VsedQXorr4xq7fvKOvPRCY",
          authDomain: "work-sheet-4e4b0.firebaseapp.com",
          projectId: "work-sheet-4e4b0",
          storageBucket: "work-sheet-4e4b0.firebasestorage.app",
          messagingSenderId: "370834015544",
          appId: "1:370834015544:web:0dc081da38c9d39dc56dcd",
          measurementId: "G-HH40E4PMM1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserRole = null;
        let currentUserId = null;
        let searchedUserUid = null;
        let searchedUserIsBlocked = false;

        // --- LOGIN ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            try { await signInWithEmailAndPassword(auth, email, pass); } 
            catch (error) { alert("Login failed: " + error.message); }
        });

        window.logout = () => signOut(auth);

        // --- AUTH STATE & BLOCK CHECK ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    
                    // SECURITY CHECK: Is this user blocked?
                    if (userData.isBlocked === true) {
                        alert("ACCESS DENIED: Your account has been blocked by the Administrator.");
                        await signOut(auth);
                        window.location.reload();
                        return;
                    }

                    currentUserRole = userData.role;
                    document.getElementById('userNameDisplay').innerText = userData.name;
                    document.getElementById('userRoleDisplay').innerText = currentUserRole;
                    
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('dashboardSection').classList.remove('hidden');
                    
                    setupUI();
                } else {
                     document.getElementById('loginSection').classList.add('hidden');
                     document.getElementById('dashboardSection').classList.remove('hidden');
                }
            } else {
                document.getElementById('loginSection').classList.remove('hidden');
                document.getElementById('dashboardSection').classList.add('hidden');
            }
        });

        // --- UI SETUP ---
        function setupUI() {
            const logCard = document.getElementById('logWorkCard');
            const adminCard = document.getElementById('adminToolsCard');
            const searchPanel = document.getElementById('searchPanel');
            const roleSelect = document.getElementById('newRole');
            const logsList = document.getElementById('logsList');
            
            // Reset
            adminCard.classList.add('hidden');
            searchPanel.classList.add('hidden');

            // 1. MD VIEW
            if (currentUserRole === 'MD') {
                logCard.classList.add('hidden');
                adminCard.classList.remove('hidden');
                searchPanel.classList.remove('hidden');
                roleSelect.innerHTML = '<option value="Employee">Employee</option><option value="HR">HR</option>';
                logsList.innerHTML = '<p class="text-muted text-center mt-4">Dashboard Clean. Use search to view Employee/HR work.</p>';
                return;
            }

            // 2. HR VIEW
            if (currentUserRole === 'HR') {
                logCard.classList.remove('hidden');
                adminCard.classList.remove('hidden');
                searchPanel.classList.remove('hidden');
                roleSelect.innerHTML = '<option value="Employee">Employee</option>';
                loadLogs(); 
                return;
            }

            // 3. EMPLOYEE VIEW
            if (currentUserRole === 'Employee') {
                logCard.classList.remove('hidden');
                loadLogs();
            }
        }

        // --- CREATE USER ---
        window.createNewUser = async () => {
            const email = document.getElementById('newEmail').value;
            const pass = document.getElementById('newPass').value;
            const name = document.getElementById('newName').value;
            const role = document.getElementById('newRole').value;

            if(!email || !pass || !name) return alert("Fill all fields");

            if(confirm(`Create ${role}: ${name}?`)) {
                try {
                    const secondaryApp = initializeApp(firebaseConfig, "SecondaryApp");
                    const secondaryAuth = getAuth(secondaryApp);
                    const userCred = await createUserWithEmailAndPassword(secondaryAuth, email, pass);
                    
                    await setDoc(doc(db, "users", userCred.user.uid), {
                        name: name,
                        name_lower: name.toLowerCase(),
                        role: role,
                        email: email,
                        isBlocked: false
                    });

                    await signOut(secondaryAuth);
                    await deleteApp(secondaryApp);

                    alert("User Created Successfully!");
                    document.getElementById('newName').value = "";
                    document.getElementById('newEmail').value = "";
                    document.getElementById('newPass').value = "";
                } catch (e) { alert("Error: " + e.message); }
            }
        };

        // --- SUBMIT WORK ---
        document.getElementById('workForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const duration = document.getElementById('workDuration').value;
            const desc = document.getElementById('workDesc').value;
            const name = document.getElementById('userNameDisplay').innerText;

            try {
                await addDoc(collection(db, "work_logs"), {
                    uid: currentUserId,
                    name: name,
                    name_lower: name.toLowerCase(),
                    duration: duration,
                    description: desc,
                    timestamp: serverTimestamp()
                });
                document.getElementById('workForm').reset();
                if(currentUserRole !== 'MD' && !searchedUserUid) loadLogs();
            } catch (error) { alert("Error: " + error.message); }
        });

        // --- SEARCH USER (TRIPLE FALLBACK SYSTEM) ---
        window.searchUserAndLogs = async () => {
            const rawTerm = document.getElementById('searchInput').value.trim();
            if(!rawTerm) return;
            
            const term = rawTerm.toLowerCase();
            const managePanel = document.getElementById('manageUserPanel');
            const list = document.getElementById('logsList');
            const btnDelete = document.getElementById('btnDeleteUser');
            
            list.innerHTML = '<p>Searching...</p>';
            managePanel.classList.add('hidden');
            searchedUserUid = null;

            let targetUid = null;
            let targetName = null;
            let targetStatus = false;

            try {
                // 1. Try Smart Search (Lowercase Name)
                let userQuery = query(collection(db, "users"), where("name_lower", "==", term));
                let userSnap = await getDocs(userQuery);

                // 2. Fallback: Try Exact Name (For old users like Pooja)
                if (userSnap.empty) {
                    userQuery = query(collection(db, "users"), where("name", "==", rawTerm));
                    userSnap = await getDocs(userQuery);
                }

                // 3. Fallback: Try Email ID
                if (userSnap.empty) {
                    userQuery = query(collection(db, "users"), where("email", "==", rawTerm));
                    userSnap = await getDocs(userQuery);
                }

                // RESULT CHECK
                if (!userSnap.empty) {
                    const uDoc = userSnap.docs[0];
                    targetUid = uDoc.id;
                    targetName = uDoc.data().name;
                    targetStatus = uDoc.data().isBlocked || false;
                }

                if (targetUid) {
                    // Update Global Vars
                    searchedUserUid = targetUid;
                    searchedUserIsBlocked = targetStatus;

                    // Show Manage Panel
                    managePanel.classList.remove('hidden');
                    document.getElementById('targetUserName').innerText = targetName;
                    
                    // Update Block Button Style
                    const blockBtn = document.getElementById('btnBlockUser');
                    if (targetStatus) {
                        blockBtn.innerText = "Unblock Access";
                        blockBtn.className = "btn btn-success fw-bold me-2";
                        document.getElementById('targetUserStatus').innerText = "BLOCKED";
                        document.getElementById('targetUserStatus').className = "text-danger fw-bold";
                    } else {
                        blockBtn.innerText = "Block Access";
                        blockBtn.className = "btn btn-warning fw-bold me-2";
                        document.getElementById('targetUserStatus').innerText = "Active";
                        document.getElementById('targetUserStatus').className = "text-success";
                    }

                    // Show Delete Button only for MD
                    if (currentUserRole === 'MD') {
                        btnDelete.classList.remove('hidden');
                    } else {
                        btnDelete.classList.add('hidden');
                    }

                    // Load logs for this user
                    loadLogs(targetUid);
                } else {
                    list.innerHTML = '<p class="text-danger">User not found. Try exact Email ID.</p>';
                }

            } catch(e) {
                console.error(e);
                list.innerHTML = `<p class="text-danger">Error: ${e.message}</p>`;
                if(e.message.includes("index")) alert("System Note: Building Index...");
            }
        }

        window.resetSearch = () => {
            document.getElementById('searchInput').value = "";
            document.getElementById('manageUserPanel').classList.add('hidden');
            searchedUserUid = null;
            setupUI();
        }

        // --- BLOCK / UNBLOCK ---
        window.toggleBlockUser = async () => {
            if (!searchedUserUid) return;
            const action = searchedUserIsBlocked ? "UNBLOCK" : "BLOCK";
            if(confirm(`Confirm: ${action} access for this user?`)) {
                try {
                    const userRef = doc(db, "users", searchedUserUid);
                    await updateDoc(userRef, { isBlocked: !searchedUserIsBlocked });
                    searchUserAndLogs(); // Refresh view
                } catch (e) { alert("Error: " + e.message); }
            }
        }

        // --- LOAD LOGS ---
        window.loadLogs = async (targetUid = null) => {
            const list = document.getElementById('logsList');
            let uidToFetch = targetUid || (currentUserRole === 'MD' ? null : currentUserId);

            if (!uidToFetch) {
                if (currentUserRole === 'MD') return;
                uidToFetch = currentUserId;
            }

            const q = query(collection(db, "work_logs"), where("uid", "==", uidToFetch), orderBy("timestamp", "desc"));

            try {
                const querySnapshot = await getDocs(q);
                list.innerHTML = '';
                
                if (querySnapshot.empty) {
                    list.innerHTML = '<p class="text-muted">No logs found.</p>';
                    return;
                }

                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const date = data.timestamp ? data.timestamp.toDate().toLocaleString() : 'Just now';
                    const html = `
                        <div class="card log-card p-2 shadow-sm">
                            <div class="d-flex justify-content-between">
                                <strong>${data.name} <span class="text-muted small">(${date})</span></strong>
                                <span class="badge bg-primary">${data.duration} Hrs</span>
                            </div>
                            <p class="mb-0 mt-1">${data.description}</p>
                        </div>
                    `;
                    list.innerHTML += html;
                });
            } catch (e) {
                list.innerHTML = `<p class="text-danger">Error: ${e.message}</p>`;
            }
        };

        // --- DELETE EMPLOYEE ---
        window.deleteEntireEmployee = async () => {
            if (!searchedUserUid || currentUserRole !== 'MD') return;
            if (confirm(`‚ö† PERMANENTLY DELETE?\n\nThis removes the User Profile AND all Work History.`)) {
                try {
                    await deleteDoc(doc(db, "users", searchedUserUid));
                    const q = query(collection(db, "work_logs"), where("uid", "==", searchedUserUid));
                    const snapshot = await getDocs(q);
                    const batch = writeBatch(db);
                    snapshot.forEach((doc) => batch.delete(doc.ref));
                    await batch.commit();
                    alert("User Deleted.");
                    resetSearch();
                } catch (e) { alert("Error: " + e.message); }
            }
        }
    </script>
</body>
</html>
